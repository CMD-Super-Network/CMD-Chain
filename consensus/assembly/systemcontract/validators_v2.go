package systemcontract

import (
	// "bytes"
	// "errors"
	// "github.com/ethereum/go-ethereum/accounts/abi"
	"bytes"
	"errors"
	"math"
	"math/big"
	"sort"

	"github.com/ethereum/go-ethereum/accounts/abi"
	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/consensus/assembly/caller"
	"github.com/ethereum/go-ethereum/core"
	"github.com/ethereum/go-ethereum/core/state"
	"github.com/ethereum/go-ethereum/core/types"
	"github.com/ethereum/go-ethereum/log"
	"github.com/ethereum/go-ethereum/params"
	// "sort"
)

const (
	validatorV2Code = "0x6080604052600436106103335760003560e01c80638a11d7c9116101ab578063b1e432ad116100f7578063c967f90f11610095578063db78dd281161006f578063db78dd28146111e7578063efd8d8e214611219578063f26fdb291461122e578063f6abfc761461124357610333565b8063c967f90f1461119e578063cd5c5342146111ca578063d6c0edad146111df57610333565b8063be645692116100d1578063be64569214611131578063bfd25ce814611146578063c253c3841461115b578063c7e4b9641461118957610333565b8063b1e432ad14610e2d578063b3c77d8014610e57578063b6c8851914610e6c57610333565b80639de7025811610164578063a224cee71161013e578063a224cee71461098f578063a406fcb714610a0a578063a43569b314610bd5578063afeea11514610e1857610333565b80639de7025814610950578063a0e8ff6614610965578063a1a7536b1461097a57610333565b80638a11d7c9146107e65780638b0e9f3f146108ab5780638c54747a146108c057806396c7cd67146108f3578063972c53561461090857806398e3b6261461091d57610333565b806340550a1c116102855780636846992a116102235780637f4f95fa116101fd5780637f4f95fa14610730578063811b0b3914610789578063817da0fd1461079e57806382bd3d92146107b357610333565b80636846992a146106415780636969a25c146106f15780637a6e91821461071b57610333565b80635dd095901161025f5780635dd09590146105cf5780636233be5d14610602578063667dd61d14610617578063671051481461062c57610333565b806340550a1c1461053f57806340a141ff146105725780634b3d500b146105a557610333565b80631b5e358c116102f257806326476204116102cc578063264762041461047557806337caa8b61461049b5780633a061bd3146105155780633a73c8811461052a57610333565b80631b5e358c146104165780631d6815161461042b5780632566392f1461044057610333565b8062362a77146103385780627ad0931461037f5780630aa01884146103a65780630cc06e2b146103d75780631303f7cf146103ec578063158ef93e14610401575b600080fd5b34801561034457600080fd5b5061036b6004803603602081101561035b57600080fd5b50356001600160a01b0316611276565b604080519115158252519081900360200190f35b34801561038b57600080fd5b506103946114e0565b60408051918252519081900360200190f35b3480156103b257600080fd5b506103bb6114e6565b604080516001600160a01b039092168252519081900360200190f35b3480156103e357600080fd5b506103946114ec565b3480156103f857600080fd5b506103946114fa565b34801561040d57600080fd5b5061036b611500565b34801561042257600080fd5b506103bb611509565b34801561043757600080fd5b5061039461150f565b34801561044c57600080fd5b506104736004803603602081101561046357600080fd5b50356001600160a01b0316611515565b005b61036b6004803603602081101561048b57600080fd5b50356001600160a01b0316611725565b3480156104a757600080fd5b506104c5600480360360208110156104be57600080fd5b5035611afb565b60408051602080825283518183015283519192839290830191858101910280838360005b838110156105015781810151838201526020016104e9565b505050509050019250505060405180910390f35b34801561052157600080fd5b506103bb611be6565b34801561053657600080fd5b50610394611bec565b34801561054b57600080fd5b5061036b6004803603602081101561056257600080fd5b50356001600160a01b0316611bf3565b34801561057e57600080fd5b506104736004803603602081101561059557600080fd5b50356001600160a01b0316611c4e565b3480156105b157600080fd5b506103bb600480360360208110156105c857600080fd5b5035611d96565b3480156105db57600080fd5b50610473600480360360208110156105f257600080fd5b50356001600160a01b0316611dbd565b34801561060e57600080fd5b506103bb611e13565b34801561062357600080fd5b50610394611e19565b34801561063857600080fd5b506103bb611e20565b34801561064d57600080fd5b506104736004803603604081101561066457600080fd5b810190602081018135600160201b81111561067e57600080fd5b82018360208201111561069057600080fd5b803590602001918460208302840111600160201b831117156106b157600080fd5b9190808060200260200160405190810160405280939291908181526020018383602002808284376000920191909152509295505091359250611e26915050565b3480156106fd57600080fd5b506103bb6004803603602081101561071457600080fd5b503561206d565b34801561072757600080fd5b5061039461207a565b34801561073c57600080fd5b5061076b6004803603604081101561075357600080fd5b506001600160a01b0381358116916020013516612148565b60408051938452602084019290925282820152519081900360600190f35b34801561079557600080fd5b506103bb612180565b3480156107aa57600080fd5b506103bb612186565b3480156107bf57600080fd5b5061036b600480360360208110156107d657600080fd5b50356001600160a01b031661218c565b3480156107f257600080fd5b506108196004803603602081101561080957600080fd5b50356001600160a01b03166123f6565b60405180886001600160a01b0316815260200187600481111561083857fe5b815260200186815260200185815260200184815260200183815260200180602001828103825283818151815260200191508051906020019060200280838360005b83811015610891578181015183820152602001610879565b505050509050019850505050505050505060405180910390f35b3480156108b757600080fd5b5061039461283c565b3480156108cc57600080fd5b50610394600480360360208110156108e357600080fd5b50356001600160a01b0316612842565b3480156108ff57600080fd5b50610394612854565b34801561091457600080fd5b50610394612864565b34801561092957600080fd5b5061036b6004803603602081101561094057600080fd5b50356001600160a01b031661286a565b34801561095c57600080fd5b506104c56128bc565b34801561097157600080fd5b5061039461291e565b34801561098657600080fd5b5061039461292e565b34801561099b57600080fd5b50610473600480360360208110156109b257600080fd5b810190602081018135600160201b8111156109cc57600080fd5b8201836020820111156109de57600080fd5b803590602001918460208302840111600160201b831117156109ff57600080fd5b509092509050612933565b348015610a1657600080fd5b5061036b600480360360c0811015610a2d57600080fd5b6001600160a01b038235169190810190604081016020820135600160201b811115610a5757600080fd5b820183602082011115610a6957600080fd5b803590602001918460018302840111600160201b83111715610a8a57600080fd5b919390929091602081019035600160201b811115610aa757600080fd5b820183602082011115610ab957600080fd5b803590602001918460018302840111600160201b83111715610ada57600080fd5b919390929091602081019035600160201b811115610af757600080fd5b820183602082011115610b0957600080fd5b803590602001918460018302840111600160201b83111715610b2a57600080fd5b919390929091602081019035600160201b811115610b4757600080fd5b820183602082011115610b5957600080fd5b803590602001918460018302840111600160201b83111715610b7a57600080fd5b919390929091602081019035600160201b811115610b9757600080fd5b820183602082011115610ba957600080fd5b803590602001918460018302840111600160201b83111715610bca57600080fd5b509092509050612cac565b348015610be157600080fd5b50610c0860048036036020811015610bf857600080fd5b50356001600160a01b03166132cf565b60405180806020018060200180602001806020018060200186810386528b818151815260200191508051906020019080838360005b83811015610c55578181015183820152602001610c3d565b50505050905090810190601f168015610c825780820380516001836020036101000a031916815260200191505b5086810385528a5181528a516020918201918c019080838360005b83811015610cb5578181015183820152602001610c9d565b50505050905090810190601f168015610ce25780820380516001836020036101000a031916815260200191505b5086810384528951815289516020918201918b019080838360005b83811015610d15578181015183820152602001610cfd565b50505050905090810190601f168015610d425780820380516001836020036101000a031916815260200191505b5086810383528851815288516020918201918a019080838360005b83811015610d75578181015183820152602001610d5d565b50505050905090810190601f168015610da25780820380516001836020036101000a031916815260200191505b50868103825287518152875160209182019189019080838360005b83811015610dd5578181015183820152602001610dbd565b50505050905090810190601f168015610e025780820380516001836020036101000a031916815260200191505b509a505050505050505050505060405180910390f35b348015610e2457600080fd5b506104c5613703565b348015610e3957600080fd5b5061047360048036036020811015610e5057600080fd5b5035613763565b348015610e6357600080fd5b506103bb6137ed565b348015610e7857600080fd5b5061036b600480360360a0811015610e8f57600080fd5b810190602081018135600160201b811115610ea957600080fd5b820183602082011115610ebb57600080fd5b803590602001918460018302840111600160201b83111715610edc57600080fd5b91908080601f0160208091040260200160405190810160405280939291908181526020018383808284376000920191909152509295949360208101935035915050600160201b811115610f2e57600080fd5b820183602082011115610f4057600080fd5b803590602001918460018302840111600160201b83111715610f6157600080fd5b91908080601f0160208091040260200160405190810160405280939291908181526020018383808284376000920191909152509295949360208101935035915050600160201b811115610fb357600080fd5b820183602082011115610fc557600080fd5b803590602001918460018302840111600160201b83111715610fe657600080fd5b91908080601f0160208091040260200160405190810160405280939291908181526020018383808284376000920191909152509295949360208101935035915050600160201b81111561103857600080fd5b82018360208201111561104a57600080fd5b803590602001918460018302840111600160201b8311171561106b57600080fd5b91908080601f0160208091040260200160405190810160405280939291908181526020018383808284376000920191909152509295949360208101935035915050600160201b8111156110bd57600080fd5b8201836020820111156110cf57600080fd5b803590602001918460018302840111600160201b831117156110f057600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600092019190915250929550613805945050505050565b34801561113d57600080fd5b506103946139aa565b34801561115257600080fd5b506103946139b9565b34801561116757600080fd5b506111706139c9565b6040805192835260208301919091528051918290030190f35b34801561119557600080fd5b506103bb6139de565b3480156111aa57600080fd5b506111b36139f2565b6040805161ffff9092168252519081900360200190f35b3480156111d657600080fd5b506103946139f7565b6104736139fc565b3480156111f357600080fd5b506111fc613d86565b6040805167ffffffffffffffff9092168252519081900360200190f35b34801561122557600080fd5b506111fc6114e0565b34801561123a57600080fd5b50610394613d8d565b34801561124f57600080fd5b5061036b6004803603602081101561126657600080fd5b50356001600160a01b0316613d9b565b600033816001600160a01b038416600090815260046020819052604090912054600160a01b900460ff16908111156112aa57fe5b14156112f3576040805162461bcd60e51b815260206004820152601360248201527215985b1a59185d1bdc881b9bdd08195e1a5cdd606a1b604482015290519081900360640190fd5b6001600160a01b0383811660009081526004602052604090205481169082161461134e5760405162461bcd60e51b815260040180806020018281038252602e8152602001806153b4602e913960400191505060405180910390fd5b6001600160a01b0383166000908152600460205260409020600901544361708090910111156113ae5760405162461bcd60e51b815260040180806020018281038252605c81526020018061525d605c913960600191505060405180910390fd5b6001600160a01b0383166000908152600460205260409020600701548061141c576040805162461bcd60e51b815260206004820152601a60248201527f596f7520646f6e2774206861766520616e792070726f66697473000000000000604482015290519081900360640190fd5b6001600160a01b03841660009081526004602052604081206007810191909155436009909101558015611481576040516001600160a01b0383169082156108fc029083906000818181858888f1935050505015801561147f573d6000803e3d6000fd5b505b816001600160a01b0316846001600160a01b03167f51a69b4502f660774c9339825c7b5adbf0b8622289134647e29728ec5d9b3bb98342604051808381526020018281526020019250505060405180910390a36001925050505b919050565b61708081565b61a00181565b690a968163f0a57b40000081565b60095481565b60005460ff1681565b61f00581565b6105b481565b3361f00514611562576040805162461bcd60e51b815260206004820152601460248201527350756e69736820636f6e7472616374206f6e6c7960601b604482015290519081900360640190fd5b6001600160a01b0381166000908152600460208190526040822054600160a01b900460ff169081111561159157fe5b14806115a05750600654600110155b156115aa57611722565b6001600160a01b03811673d1a4e4fbc69e17cabb96fd0d45cf98889b85034714156115d457611722565b6115dd81613ea3565b6001600160a01b038116600090815260046020526040902060010154690a968163f0a57b40000011611656576001600160a01b03811660009081526004602052604090206001015461163990690a968163f0a57b400000613fba565b6001600160a01b0382166000908152600460205260409020600101555b6001600160a01b0381166000908152600460205260409020600101546a0422ca8b0a00a42500000011156116ae576001600160a01b0381166000908152600460205260409020805460ff60a01b1916600360a01b1790555b6001600160a01b0381166000908152600460205260409020600101546116d5908290614005565b60408051690a968163f0a57b400000815242602082015281516001600160a01b038416927f3cdf1ba6a0e21f7ff30da27188b092549ec0dff479879070791a6ef8e4e05054928290030190a25b50565b6000805460ff1661176c576040805162461bcd60e51b815260206004820152600c60248201526b139bdd081a5b9a5d081e595d60a21b604482015290519081900360640190fd5b333460016001600160a01b038516600090815260046020819052604090912054600160a01b900460ff16908111156117a057fe5b14806117db575060026001600160a01b038516600090815260046020819052604090912054600160a01b900460ff16908111156117d957fe5b145b80611815575060036001600160a01b038516600090815260046020819052604090912054600160a01b900460ff169081111561181357fe5b145b6118505760405162461bcd60e51b815260040180806020018281038252602d815260200180615308602d913960400191505060405180910390fd5b600a546040805163416259d960e11b81526001600160a01b038781166004830152915191909216916382c4b3b2916024808301926020929190829003018186803b15801561189d57600080fd5b505afa1580156118b1573d6000803e3d6000fd5b505050506040513d60208110156118c757600080fd5b50516119045760405162461bcd60e51b81526004018080602001828103825260388152602001806153566038913960400191505060405180910390fd5b6001600160a01b03808316600090815260056020908152604080832093881683529290522060010154156119695760405162461bcd60e51b81526004018080602001828103825260228152602001806152e66022913960400191505060405180910390fd5b6001600160a01b03808516600081815260046020908152604080832094871683526005825280832093835292905220546119ee57600a810180546001600160a01b038086166000818152600560209081526040808320948c16835293815292812060020184905560018401855593845292200180546001600160a01b03191690911790555b60018101546119fd9083614017565b600182015560028154600160a01b900460ff166004811115611a1b57fe5b14611a3257805460ff60a01b1916600160a11b1781555b611a40858260010154614005565b6001600160a01b03808416600090815260056020908152604080832093891683529290522054611a709083614017565b6001600160a01b038085166000908152600560209081526040808320938a1683529290522055600854611aa39083614017565b6008556040805183815242602082015281516001600160a01b0380891693908716927fb9ba725934532316cffe10975da6eb25ad49c2d1c294d982c46c9f8d684ee075929081900390910190a3506001949350505050565b6060600354821115611b0d5760035491505b60608267ffffffffffffffff81118015611b2657600080fd5b50604051908082528060200260200182016040528015611b50578160200160208202803683370190505b506001600090815260026020527fe90b7bceb6e7df5418fb78d8ee546e97c83a08bbccc01a0644d599ccd2a7c2e0549192506001600160a01b03909116905b84811015611bdd5781838281518110611ba457fe5b6001600160a01b039283166020918202929092018101919091529281166000908152600290935260409092205490911690600101611b8f565b50909392505050565b61f00481565b6206978081565b6000805b600654811015611c4557826001600160a01b031660068281548110611c1857fe5b6000918252602090912001546001600160a01b03161415611c3d5760019150506114db565b600101611bf7565b50600092915050565b3361f00514611c9b576040805162461bcd60e51b815260206004820152601460248201527350756e69736820636f6e7472616374206f6e6c7960601b604482015290519081900360640190fd5b6001600160a01b038116600090815260046020526040902060070154611cc082613ea3565b60075460011015611d9257611cd482614071565b600a54604080516315ea278160e01b81526001600160a01b038581166004830152915191909216916315ea27819160248083019260209291908290030181600087803b158015611d2357600080fd5b505af1158015611d37573d6000803e3d6000fd5b505050506040513d6020811015611d4d57600080fd5b50506040805182815242602082015281516001600160a01b038516927fa26de7ab324eac08c596549f421e5c8741213d237d2e9a2c9c0ebde0a7a849fe928290030190a25b5050565b60078181548110611da357fe5b6000918252602090912001546001600160a01b0316905081565b3361f00514611e0a576040805162461bcd60e51b815260206004820152601460248201527350756e69736820636f6e7472616374206f6e6c7960601b604482015290519081900360640190fd5b61172281613ea3565b61f00681565b620d2f0081565b61f00781565b334114611e67576040805162461bcd60e51b815260206004820152600a6024820152694d696e6572206f6e6c7960b01b604482015290519081900360640190fd5b436000908152600c602090815260408083206001845290915290205460ff1615611ed8576040805162461bcd60e51b815260206004820152601a60248201527f56616c696461746f727320616c72656164792075706461746564000000000000604482015290519081900360640190fd5b60005460ff16611f1e576040805162461bcd60e51b815260206004820152600c60248201526b139bdd081a5b9a5d081e595d60a21b604482015290519081900360640190fd5b80804381611f2857fe5b0615611f6e576040805162461bcd60e51b815260206004820152601060248201526f426c6f636b2065706f6368206f6e6c7960801b604482015290519081900360640190fd5b436000908152600c6020908152604080832060018085529252909120805460ff191690911790558251611fdf576040805162461bcd60e51b815260206004820152601460248201527356616c696461746f722073657420656d7074792160601b604482015290519081900360640190fd5b8251611ff290600690602086019061508f565b507feacea8f3c22f06c0b18306bdb04d0a967255129e8ce0094debb0a0ff89d006b5836040518080602001828103825283818151815260200191508051906020019060200280838360005b8381101561205557818101518382015260200161203d565b505050509050019250505060405180910390a1505050565b60068181548110611da357fe5b600080805b600654811015612142576002600460006006848154811061209c57fe5b60009182526020808320909101546001600160a01b0316835282019290925260400190205460ff600160a01b9091041660048111156120d757fe5b14801561212757506a0422ca8b0a00a42500000060046000600684815481106120fc57fe5b60009182526020808320909101546001600160a01b0316835282019290925260400190206001015410155b1561213a57612137826001614017565b91505b60010161207f565b50905090565b6001600160a01b0391821660009081526005602090815260408083209390941682529190915220805460018201546002909201549092565b61a00281565b61f00381565b60003361f006146121dd576040805162461bcd60e51b815260206004820152601660248201527550726f706f73616c20636f6e7472616374206f6e6c7960501b604482015290519081900360640190fd5b60005460ff16612223576040805162461bcd60e51b815260206004820152600c60248201526b139bdd081a5b9a5d081e595d60a21b604482015290519081900360640190fd5b60036001600160a01b038316600090815260046020819052604090912054600160a01b900460ff169081111561225557fe5b14158015612293575060046001600160a01b038316600090815260046020819052604090912054600160a01b900460ff169081111561229057fe5b14155b156122a0575060016114db565b60046001600160a01b038316600090815260046020819052604090912054600160a01b900460ff16908111156122d257fe5b141561239357600b54604080516363e1d45160e01b81526001600160a01b038581166004830152915191909216916363e1d4519160248083019260209291908290030181600087803b15801561232757600080fd5b505af115801561233b573d6000803e3d6000fd5b505050506040513d602081101561235157600080fd5b5051612393576040805162461bcd60e51b815260206004820152600c60248201526b18db19585b8819985a5b195960a21b604482015290519081900360640190fd5b6001600160a01b038216600081815260046020908152604091829020805460ff60a01b1916600160a01b179055815142815291517fd8b2c426ec1be69ca7583d26b1e893946e3227430d3ebc3bd64d9e1c469cb4009281900390910190a2919050565b60008060008060008060606124096150f4565b6001600160a01b038981166000908152600460208181526040928390208351610100810190945280549485168452929390840191600160a01b90910460ff169081111561245257fe5b600481111561245d57fe5b815260200160018201548152602001600282016040518060a0016040529081600082018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156125145780601f106124e957610100808354040283529160200191612514565b820191906000526020600020905b8154815290600101906020018083116124f757829003601f168201915b50505050508152602001600182018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156125b65780601f1061258b576101008083540402835291602001916125b6565b820191906000526020600020905b81548152906001019060200180831161259957829003601f168201915b5050509183525050600282810180546040805160206001841615610100026000190190931694909404601f810183900483028501830190915280845293810193908301828280156126485780601f1061261d57610100808354040283529160200191612648565b820191906000526020600020905b81548152906001019060200180831161262b57829003601f168201915b505050918352505060038201805460408051602060026001851615610100026000190190941693909304601f81018490048402820184019092528181529382019392918301828280156126dc5780601f106126b1576101008083540402835291602001916126dc565b820191906000526020600020905b8154815290600101906020018083116126bf57829003601f168201915b505050918352505060048201805460408051602060026001851615610100026000190190941693909304601f81018490048402820184019092528181529382019392918301828280156127705780601f1061274557610100808354040283529160200191612770565b820191906000526020600020905b81548152906001019060200180831161275357829003601f168201915b5050505050815250508152602001600782015481526020016008820154815260200160098201548152602001600a82018054806020026020016040519081016040528092919081815260200182805480156127f457602002820191906000526020600020905b81546001600160a01b031681526001909101906020018083116127d6575b505050505081525050905080600001518160200151826040015183608001518460a001518560c001518660e00151975097509750975097509750975050919395979092949650565b60085481565b60016020526000908152604090205481565b6b0d92289838d21a996800000081565b60035481565b6000805b600754811015611c4557826001600160a01b03166007828154811061288f57fe5b6000918252602090912001546001600160a01b031614156128b45760019150506114db565b60010161286e565b6060600680548060200260200160405190810160405280929190818152602001828054801561291457602002820191906000526020600020905b81546001600160a01b031681526001909101906020018083116128f6575b5050505050905090565b6b015b6a759f4835dc2400000081565b600181565b60005460ff1615612981576040805162461bcd60e51b8152602060048201526013602482015272105b1c9958591e481a5b9a5d1a585b1a5e9959606a1b604482015290519081900360640190fd5b600a80546001600160a01b031990811661f00617909155600b8054821661f0051790556001600081815260026020527fe90b7bceb6e7df5418fb78d8ee546e97c83a08bbccc01a0644d599ccd2a7c2e080549093169091179091555b81811015612c9a5760008383838181106129f357fe5b905060200201356001600160a01b03166001600160a01b03161415612a5f576040805162461bcd60e51b815260206004820152601960248201527f496e76616c69642076616c696461746f72206164647265737300000000000000604482015290519081900360640190fd5b612a83838383818110612a6e57fe5b905060200201356001600160a01b0316611bf3565b612ad2576006838383818110612a9557fe5b835460018101855560009485526020948590200180546001600160a01b0319166001600160a01b0395909202939093013593909316929092179055505b612af6838383818110612ae157fe5b905060200201356001600160a01b031661286a565b612b2857612b20838383818110612b0957fe5b905060200201356001600160a01b031660016140dd565b612b28614173565b6000600481858585818110612b3957fe5b6001600160a01b0360209182029390930135831684528301939093526040909101600020541691909114159050612bee57828282818110612b7657fe5b905060200201356001600160a01b031660046000858585818110612b9657fe5b905060200201356001600160a01b03166001600160a01b03166001600160a01b0316815260200190815260200160002060000160006101000a8154816001600160a01b0302191690836001600160a01b031602179055505b600060046000858585818110612c0057fe5b602090810292909201356001600160a01b031683525081019190915260400160002054600160a01b900460ff166004811115612c3857fe5b1415612c9257600260046000858585818110612c5057fe5b602090810292909201356001600160a01b0316835250810191909152604001600020805460ff60a01b1916600160a01b836004811115612c8c57fe5b02179055505b6001016129dd565b50506000805460ff1916600117905550565b6000805460ff16612cf3576040805162461bcd60e51b815260206004820152600c60248201526b139bdd081a5b9a5d081e595d60a21b604482015290519081900360640190fd5b6001600160a01b038c16612d44576040805162461bcd60e51b8152602060048201526013602482015272496e76616c696420666565206164647265737360681b604482015290519081900360640190fd5b612e538b8b8080601f01602080910402602001604051908101604052809392919081815260200183838082843760009201919091525050604080516020601f8f018190048102820181019092528d815292508d91508c908190840183828082843760009201919091525050604080516020601f8e018190048102820181019092528c815292508c91508b908190840183828082843760009201919091525050604080516020601f8d018190048102820181019092528b815292508b91508a908190840183828082843760009201919091525050604080516020601f8c018190048102820181019092528a815292508a915089908190840183828082843760009201919091525061380592505050565b612e9a576040805162461bcd60e51b815260206004820152601360248201527224b73b30b634b2103232b9b1b934b83a34b7b760691b604482015290519081900360640190fd5b336000806001600160a01b038316600090815260046020819052604090912054600160a01b900460ff1690811115612ece57fe5b1415612fd657600a546040805163416259d960e11b81526001600160a01b038581166004830152915191909216916382c4b3b2916024808301926020929190829003018186803b158015612f2157600080fd5b505afa158015612f35573d6000803e3d6000fd5b505050506040513d6020811015612f4b57600080fd5b5051612f9e576040805162461bcd60e51b815260206004820152601c60248201527f596f75206d75737420626520617574686f72697a656420666972737400000000604482015290519081900360640190fd5b506001600160a01b0381166000908152600460205260408120805460ff60a01b1916600160a01b179055600190612fd69083906140dd565b6001600160a01b038281166000908152600460205260409020548116908f1614613048578d60046000846001600160a01b03166001600160a01b0316815260200190815260200160002060000160006101000a8154816001600160a01b0302191690836001600160a01b031602179055505b6040518060a001604052808e8e8080601f016020809104026020016040519081016040528093929190818152602001838380828437600092019190915250505090825250604080516020601f8f018190048102820181019092528d815291810191908e908e9081908401838280828437600092019190915250505090825250604080516020601f8d018190048102820181019092528b815291810191908c908c9081908401838280828437600092019190915250505090825250604080516020601f8b0181900481028201810190925289815291810191908a908a9081908401838280828437600092019190915250505090825250604080516020601f89018190048102820181019092528781529181019190889088908190840183828082843760009201829052509390945250506001600160a01b038516815260046020908152604090912083518051600290920193506131a8928492910190615140565b5060208281015180516131c19260018501920190615140565b50604082015180516131dd916002840191602090910190615140565b50606082015180516131f9916003840191602090910190615140565b5060808201518051613215916004840191602090910190615140565b50905050801561326f578d6001600160a01b0316826001600160a01b03167f887eec9d757b7247dd8e51198f9d1b8f27979bceb34bdcc1bffd4ec5ec736c22426040518082815260200191505060405180910390a36132bb565b8d6001600160a01b0316826001600160a01b03167fb8421f65501371f54d58de1937ff1e1ccdb76423ef6f84acea1814a0f6362ca0426040518082815260200191505060405180910390a35b5060019d9c50505050505050505050505050565b60608060608060606132df6150f4565b6001600160a01b038781166000908152600460208181526040928390208351610100810190945280549485168452929390840191600160a01b90910460ff169081111561332857fe5b600481111561333357fe5b815260200160018201548152602001600282016040518060a0016040529081600082018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156133ea5780601f106133bf576101008083540402835291602001916133ea565b820191906000526020600020905b8154815290600101906020018083116133cd57829003601f168201915b50505050508152602001600182018054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561348c5780601f106134615761010080835404028352916020019161348c565b820191906000526020600020905b81548152906001019060200180831161346f57829003601f168201915b5050509183525050600282810180546040805160206001841615610100026000190190931694909404601f8101839004830285018301909152808452938101939083018282801561351e5780601f106134f35761010080835404028352916020019161351e565b820191906000526020600020905b81548152906001019060200180831161350157829003601f168201915b505050918352505060038201805460408051602060026001851615610100026000190190941693909304601f81018490048402820184019092528181529382019392918301828280156135b25780601f10613587576101008083540402835291602001916135b2565b820191906000526020600020905b81548152906001019060200180831161359557829003601f168201915b505050918352505060048201805460408051602060026001851615610100026000190190941693909304601f81018490048402820184019092528181529382019392918301828280156136465780601f1061361b57610100808354040283529160200191613646565b820191906000526020600020905b81548152906001019060200180831161362957829003601f168201915b5050505050815250508152602001600782015481526020016008820154815260200160098201548152602001600a82018054806020026020016040519081016040528092919081815260200182805480156136ca57602002820191906000526020600020905b81546001600160a01b031681526001909101906020018083116136ac575b5050509190925250505060609081015180516020820151604083015193830151608090930151919b909a50929850909650945092505050565b60606007805480602002602001604051908101604052809291908181526020018280548015612914576020028201919060005260206000209081546001600160a01b031681526001909101906020018083116128f6575050505050905090565b3341146137a4576040805162461bcd60e51b815260206004820152600a6024820152694d696e6572206f6e6c7960b01b604482015290519081900360640190fd5b6a0422ca8b0a00a42500000081116117225760405162461bcd60e51b815260040180806020018281038252602d8152602001806152b9602d913960400191505060405180910390fd5b73d1a4e4fbc69e17cabb96fd0d45cf98889b85034781565b6000604686511115613857576040805162461bcd60e51b8152602060048201526016602482015275092dcecc2d8d2c840dadedcd2d6cae440d8cadccee8d60531b604482015290519081900360640190fd5b610bb8855111156138af576040805162461bcd60e51b815260206004820152601760248201527f496e76616c6964206964656e74697479206c656e677468000000000000000000604482015290519081900360640190fd5b608c845111156138ff576040805162461bcd60e51b8152602060048201526016602482015275092dcecc2d8d2c840eecac4e6d2e8ca40d8cadccee8d60531b604482015290519081900360640190fd5b608c8351111561394d576040805162461bcd60e51b8152602060048201526014602482015273092dcecc2d8d2c840cadac2d2d840d8cadccee8d60631b604482015290519081900360640190fd5b6101188251111561399e576040805162461bcd60e51b8152602060048201526016602482015275092dcecc2d8d2c840c8cae8c2d2d8e640d8cadccee8d60531b604482015290519081900360640190fd5b50600195945050505050565b6a0422ca8b0a00a42500000081565b6b07fdacf155df27a328c0000081565b6000806139d660006142fd565b915091509091565b60005461010090046001600160a01b031681565b603381565b603c81565b334114613a3d576040805162461bcd60e51b815260206004820152600a6024820152694d696e6572206f6e6c7960b01b604482015290519081900360640190fd5b436000908152600c6020908152604080832083805290915290205460ff1615613aad576040805162461bcd60e51b815260206004820152601960248201527f426c6f636b20697320616c726561647920726577617264656400000000000000604482015290519081900360640190fd5b60005460ff16613af3576040805162461bcd60e51b815260206004820152600c60248201526b139bdd081a5b9a5d081e595d60a21b604482015290519081900360640190fd5b436000908152600c602090815260408083208380528252808320805460ff191660011790553380845260049283905290832054909234929091600160a01b900460ff1690811115613b4057fe5b1415613b4d575050613d84565b600061a0026001600160a01b03166318160ddd6040518163ffffffff1660e01b815260040160206040518083038186803b158015613b8a57600080fd5b505afa158015613b9e573d6000803e3d6000fd5b505050506040513d6020811015613bb457600080fd5b505160408051635fdf60fb60e01b8152905191925060009161a00291635fdf60fb916004808301926020929190829003018186803b158015613bf557600080fd5b505afa158015613c09573d6000803e3d6000fd5b505050506040513d6020811015613c1f57600080fd5b505160408051630ac168a160e01b8152905191925060009161a00291630ac168a1916004808301926020929190829003018186803b158015613c6057600080fd5b505afa158015613c74573d6000803e3d6000fd5b505050506040513d6020811015613c8a57600080fd5b505190506000613ca66064613ca084600a6143eb565b90614444565b905080613cb38585613fba565b118015613cca57506000613cc78683613fba565b10155b15613d305761f0076001600160a01b03166330f3f0db826040518263ffffffff1660e01b815260040180828152602001915050600060405180830381600087803b158015613d1757600080fd5b505af1158015613d2b573d6000803e3d6000fd5b505050505b613d3b856000614486565b6040805186815242602082015281516001600160a01b038916927f7dc4e5df59513708dca355b8706273a5df7b810a4cec8019f2a4b9bb166a1a04928290030190a25050505050505b565b6201518081565b693ceab05409db274d269381565b6000613da633611bf3565b613df7576040805162461bcd60e51b815260206004820152601d60248201527f6f6e6c7920616374697665642076616c696461746f722063616e20646f000000604482015290519081900360640190fd5b600654613e03836147ab565b15613e3f5760405162461bcd60e51b815260040180806020018281038252602681526020018061538e6026913960400191505060405180910390fd5b60005b81811015613e9957336001600160a01b031660068281548110613e6157fe5b6000918252602090912001546001600160a01b03161415613e9157613e863385614800565b6001925050506114db565b600101613e42565b5060009392505050565b6001600160a01b0381166000908152600460208190526040822054600160a01b900460ff1690811115613ed257fe5b1480613ee15750600654600110155b15613eeb57611722565b6001600160a01b0381166000908152600460205260409020600701548015613f7457613f178183614486565b600954613f249082614017565b6009556001600160a01b038216600090815260046020526040902060080154613f4d9082614017565b6001600160a01b038316600090815260046020526040812060088101929092556007909101555b6040805182815242602082015281516001600160a01b038516927fe294e9d73f8eee23e21b2e1567960625a6b5d339cb127b55d0d09473a9951235928290030190a25050565b6000613ffc83836040518060400160405280601e81526020017f536166654d6174683a207375627472616374696f6e206f766572666c6f770000815250614d24565b90505b92915050565b61400f8282614dbb565b611d92614173565b600082820183811015613ffc576040805162461bcd60e51b815260206004820152601b60248201527f536166654d6174683a206164646974696f6e206f766572666c6f770000000000604482015290519081900360640190fd5b6001600160a01b0381166000908152600460208190526040822054600160a01b900460ff16908111156140a057fe5b14156140ab57611722565b6001600160a01b0381166000908152600460205260409020805460ff60a01b1916600160a21b17905561172281614e4b565b6001600160a01b03828116600090815260026020526040902054161561410257611d92565b600061410d82614e54565b6001600160a01b03938416600081815260016020818152604080842097909755938716808352600290945285822080548484529683208054979098166001600160a01b031997881617909755929052845490931690921790925560038054909101905550565b6060614180600354611afb565b905061418e600760006151ba565b80516000805b828110156142f75773d1a4e4fbc69e17cabb96fd0d45cf98889b8503476001600160a01b03168482815181106141c657fe5b60200260200101516001600160a01b031614156142425760078482815181106141eb57fe5b60209081029190910181015182546001808201855560009485529290932090920180546001600160a01b0319166001600160a01b03909316929092179091559190910190603382141561423d576142f7565b6142ef565b6a0422ca8b0a00a4250000006004600086848151811061425e57fe5b60200260200101516001600160a01b03166001600160a01b0316815260200190815260200160002060010154106142ef57600784828151811061429d57fe5b60209081029190910181015182546001808201855560009485529290932090920180546001600160a01b0319166001600160a01b0390931692909217909155919091019060338214156142ef576142f7565b600101614194565b50505050565b60008060005b6006548110156143e55760048060006006848154811061431f57fe5b60009182526020808320909101546001600160a01b0316835282019290925260400190205460ff600160a01b90910416600481111561435a57fe5b1415801561438c57506006818154811061437057fe5b6000918252602090912001546001600160a01b03858116911614155b156143dd576143d460046000600684815481106143a557fe5b60009182526020808320909101546001600160a01b031683528201929092526040019020600101548490614017565b92506001909101905b600101614303565b50915091565b6000826143fa57506000613fff565b8282028284828161440757fe5b0414613ffc5760405162461bcd60e51b81526004018080602001828103825260218152602001806153356021913960400191505060405180910390fd5b6000613ffc83836040518060400160405280601a81526020017f536166654d6174683a206469766973696f6e206279207a65726f000000000000815250614ead565b8161449057611d92565b60008061449c836142fd565b9092509050806144ad575050611d92565b6000808361461d5760006144c18785614444565b90506144d76144d082866143eb565b8890613fba565b925060005b6006548110156145b2576000600682815481106144f557fe5b6000918252602090912001546001600160a01b0316905060046001600160a01b038216600090815260046020819052604090912054600160a01b900460ff169081111561453e57fe5b1415801561455e5750876001600160a01b0316816001600160a01b031614155b156145a9576001600160a01b0381166000908152600460205260409020600701546145899084614017565b6001600160a01b0382166000908152600460205260409020600701559250825b506001016144dc565b506000831180156145cb57506001600160a01b03821615155b15614613576001600160a01b0382166000908152600460205260409020600701546145f69084614017565b6001600160a01b0383166000908152600460205260409020600701555b5050505050611d92565b6000805b6006548110156147355760006006828154811061463a57fe5b6000918252602090912001546001600160a01b0316905060046001600160a01b038216600090815260046020819052604090912054600160a01b900460ff169081111561468357fe5b141580156146a35750876001600160a01b0316816001600160a01b031614155b1561472c576001600160a01b0381166000908152600460205260408120600101546146d5908990613ca0908d906143eb565b90506146e18482614017565b6001600160a01b0383166000908152600460205260409020600701549295509350849161470e9082614017565b6001600160a01b038316600090815260046020526040902060070155505b50600101614621565b506147408782613fba565b925060008311801561475a57506001600160a01b03821615155b156147a2576001600160a01b0382166000908152600460205260409020600701546147859084614017565b6001600160a01b0383166000908152600460205260409020600701555b50505050505050565b600654600090815b81811015613e9957836001600160a01b0316600682815481106147d257fe5b6000918252602090912001546001600160a01b031614156147f8576001925050506114db565b6001016147b3565b6001600160a01b038083166000908152600460208190526040808320600180820154958716808652928520908101959095556007808201549086015560088082015490860155549252825460ff600160a01b9384900416939260ff60a01b1990911691849081111561486e57fe5b02179055506001600160a01b03818116600081815260046020908152604080832080546001600160a01b0319169094179093559285168152818120805460ff60a01b1916600160a21b178155600181018290556008810191909155600a01805482518185028101850190935280835260609383018282801561491957602002820191906000526020600020905b81546001600160a01b031681526001909101906020018083116148fb575b505083519394506000925050505b81811015614b505760046000856001600160a01b03166001600160a01b03168152602001908152602001600020600a0183828151811061496357fe5b60209081029190910181015182546001810184556000938452919092200180546001600160a01b0319166001600160a01b039092169190911790556149a66151d8565b600560008584815181106149b657fe5b60200260200101516001600160a01b03166001600160a01b031681526020019081526020016000206000876001600160a01b03166001600160a01b0316815260200190815260200160002060405180606001604052908160008201548152602001600182015481526020016002820154815250509050806000015160056000868581518110614a4157fe5b60200260200101516001600160a01b03166001600160a01b031681526020019081526020016000206000876001600160a01b03166001600160a01b0316815260200190815260200160002060000181905550806020015160056000868581518110614aa857fe5b60200260200101516001600160a01b03166001600160a01b031681526020019081526020016000206000876001600160a01b03166001600160a01b0316815260200190815260200160002060010181905550806040015160056000868581518110614b0f57fe5b6020908102919091018101516001600160a01b0390811683528282019390935260409182016000908120938a16815292905290206002015550600101614927565b506001600160a01b0384166000908152600460205260408120614b7891600a909101906151ba565b6001600160a01b038316600090815260046020526040902060010154614b9f9084906140dd565b614ba884614f12565b6001600160a01b03841660009081526004602052604081206007018054919055614bd0614173565b614bd985613ea3565b600a5460408051631204145960e01b81526001600160a01b038881166004830152878116602483015291519190921691631204145991604480830192600092919082900301818387803b158015614c2f57600080fd5b505af1158015614c43573d6000803e3d6000fd5b5050505060016007805490501115614d1d57614c5e85614071565b600a54604080516315ea278160e01b81526001600160a01b038881166004830152915191909216916315ea27819160248083019260209291908290030181600087803b158015614cad57600080fd5b505af1158015614cc1573d6000803e3d6000fd5b505050506040513d6020811015614cd757600080fd5b50506040805142815290516001600160a01b0380871692908816917fc99c7a81ac29d57ca44522273d13fd4f068d63d610b2631d7f1271a484bcc5179181900360200190a35b5050505050565b60008184841115614db35760405162461bcd60e51b81526004018080602001828103825283818151815260200191508051906020019080838360005b83811015614d78578181015183820152602001614d60565b50505050905090810190601f168015614da55780820380516001836020036101000a031916815260200191505b509250505060405180910390fd5b505050900390565b6001600160a01b0382811660009081526002602052604090205416614ddf57611d92565b6000614dea83614fa0565b6001600160a01b0380851660009081526002602052604090205491925016614e13828483614ffd565b15614e38576001600160a01b03841660009081526001602052604090208390556142f7565b614e4184614f12565b6142f784846140dd565b61172281614f12565b600060015b6001600160a01b03808216600090815260026020526040902054614e81918391869116614ffd565b15614e8d5790506114db565b6001600160a01b0390811660009081526002602052604090205416614e59565b60008183614efc5760405162461bcd60e51b8152602060048201818152835160248401528351909283926044909101919085019080838360008315614d78578181015183820152602001614d60565b506000838581614f0857fe5b0495945050505050565b6001600160a01b0381811660009081526002602052604090205416614f3657611722565b6000614f4182614fa0565b6001600160a01b039283166000818152600260209081526040808320805495881684528184208054969098166001600160a01b031996871617909755928252855490931690945560019091528220919091555060038054600019019055565b600060015b6001600160a01b0381811660009081526002602052604090205416600114611c4557614fd1838261506d565b15614fdd5790506114db565b6001600160a01b0390811660009081526002602052604090205416614fa5565b60006001600160a01b0384166001148061502f57506001600160a01b0384166000908152600160205260409020548311155b801561506557506001600160a01b0382166001148061506557506001600160a01b03821660009081526001602052604090205483115b949350505050565b6001600160a01b03908116600090815260026020526040902054811691161490565b8280548282559060005260206000209081019282156150e4579160200282015b828111156150e457825182546001600160a01b0319166001600160a01b039091161782556020909201916001909101906150af565b506150f09291506151f9565b5090565b6040805161010081019091526000808252602082019081526020016000815260200161511e615218565b8152602001600081526020016000815260200160008152602001606081525090565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061518157805160ff19168380011785556151ae565b828001600101855582156151ae579182015b828111156151ae578251825591602001919060010190615193565b506150f0929150615247565b50805460008255906000526020600020908101906117229190615247565b60405180606001604052806000815260200160008152602001600081525090565b5b808211156150f05780546001600160a01b03191681556001016151fa565b6040518060a0016040528060608152602001606081526020016060815260200160608152602001606081525090565b5b808211156150f0576000815560010161524856fe596f75206d757374207761697420656e6f75676820626c6f636b7320746f20776974686472617720796f75722070726f66697473206166746572206c6174657374207769746864726177206f6620746869732076616c696461746f726e65772076616c7565206d757374206c6172676572207468616e204d696e696d616c5374616b696e67436f696e43616e2774207374616b65207768656e20796f752061726520756e7374616b696e6743616e2774207374616b6520746f20612076616c696461746f7220696e2061626e6f726d616c20737461747573536166654d6174683a206d756c7469706c69636174696f6e206f766572666c6f775468652076616c696461746f7220796f752077616e7420746f207374616b65206d75737420626520617574686f72697a6564206669727374616464726573732069732076616c696461746f722c2063616e206e6f74207265757365206974596f7520617265206e6f742074686520666565207265636569766572206f6620746869732076616c696461746f72a26469706673582212201a322607d74e39b8e449fa180da3a26ddb1c31ac2432ab7c06466d798ceb699864736f6c634300060c0033"
)

type forkValidatorsV2 struct {
	abi          abi.ABI
	contractAddr common.Address
}

func NewValidatorV2() *forkValidatorsV2 {
	return &forkValidatorsV2{
		abi:          abiMap[ValidatorsV2ContractName],
		contractAddr: ValidatorsV2ContractAddr,
	}
}

func (v *forkValidatorsV2) GetTopValidators(statedb *state.StateDB, header *types.Header, chainContext core.ChainContext, config *params.ChainConfig) ([]common.Address, error) {
	method := "getTopValidators"
	data, err := v.abi.Pack(method)
	if err != nil {
		log.Error("Can't pack data for getTopValidators", "error", err)
		return []common.Address{}, err
	}

	msg := types.NewMessage(header.Coinbase, &v.contractAddr, 0, new(big.Int), math.MaxUint64, new(big.Int), data, false)

	result, err := caller.ExecuteMsg(msg, statedb, header, chainContext, config)
	if err != nil {
		return []common.Address{}, err
	}

	// unpack data
	ret, err := v.abi.Unpack(method, result)
	if err != nil {
		return []common.Address{}, err
	}
	if len(ret) != 1 {
		return []common.Address{}, errors.New("invalid params length")
	}
	validators, ok := ret[0].([]common.Address)
	if !ok {
		return []common.Address{}, errors.New("invalid validators format")
	}
	sort.Slice(validators, func(i, j int) bool {
		return bytes.Compare(validators[i][:], validators[j][:]) < 0
	})
	return validators, err
}

func (f *forkValidatorsV2) GetName() string {
	return ValidatorsV2ContractName
}

func (f *forkValidatorsV2) Update(config *params.ChainConfig, height *big.Int, state *state.StateDB) (err error) {
	contractCode := common.FromHex(validatorV2Code)

	//write code to sys contract
	state.SetCode(ValidatorsV2ContractAddr, contractCode)
	log.Debug("Write code to system contract account", "addr", ValidatorsV2ContractAddr.String(), "code", validatorV2Code)

	return
}

func (f *forkValidatorsV2) Execute(state *state.StateDB, header *types.Header, chainContext core.ChainContext, config *params.ChainConfig) (err error) {

	//First, get top validators from the old contract
	v0 := NewValidatorV0()
	topVals, err := v0.GetTopValidators(state, header, chainContext, config)
	if err != nil {
		log.Error("getTopValidators from V0 failed", "err", err)
		return err
	}
	// managers := make([]common.Address, 0, len(topVals))
	// for _, val := range topVals {
	// 	feeAddr, err := v0.GetValidatorFeeAddr(val, state, header, chainContext, config)
	// 	if err != nil {
	// 		return err
	// 	}
	// 	managers = append(managers, feeAddr)
	// }

	// initialize v1 contract
	method := "initialize"
	data, err := GetInteractiveABI()[ValidatorsV2ContractName].Pack(method, topVals)
	if err != nil {
		log.Error("Can't pack data for initialize", "error", err)
		return err
	}

	msg := types.NewMessage(header.Coinbase, &ValidatorsV2ContractAddr, 0, new(big.Int), math.MaxUint64, new(big.Int), data, false)
	_, err = caller.ExecuteMsg(msg, state, header, chainContext, config)

	return
}
