package systemcontract

import (
	// "bytes"
	// "errors"
	// "github.com/ethereum/go-ethereum/accounts/abi"

	"math"
	"math/big"

	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/consensus/assembly/caller"
	"github.com/ethereum/go-ethereum/core"
	"github.com/ethereum/go-ethereum/core/state"
	"github.com/ethereum/go-ethereum/core/types"
	"github.com/ethereum/go-ethereum/log"
	"github.com/ethereum/go-ethereum/params"
	// "sort"
)

const (
	validatorV3Code = "0x6080604052600436106103b65760003560e01c806382bd3d92116101f2578063b3c77d801161010d578063cd5c5342116100a0578063f26fdb291161006f578063f26fdb2914611371578063f342da3314611386578063f6abfc761461139b578063fc6c1f02146113ce576103b6565b8063cd5c5342146104c3578063d6c0edad14611322578063db78dd281461132a578063efd8d8e21461135c576103b6565b8063bfd25ce8116100dc578063bfd25ce81461129e578063c253c384146112b3578063c7e4b964146112e1578063c967f90f146112f6576103b6565b8063b3c77d8014610f9a578063b6c8851914610faf578063be64569214611274578063bfd1a8a114611289576103b6565b8063a0e8ff6611610185578063a6943ab211610154578063a6943ab214610f13578063afeea11514610f28578063b1e432ad14610f3d578063b1ea092314610f67576103b6565b8063a0e8ff6614610a75578063a224cee714610a8a578063a406fcb714610b05578063a43569b314610cd0576103b6565b806396c7cd67116101c157806396c7cd6714610a03578063972c535614610a1857806398e3b62614610a2d5780639de7025814610a60576103b6565b806382bd3d92146108c35780638a11d7c9146108f65780638b0e9f3f146109bb5780638c54747a146109d0576103b6565b80633a73c881116102e257806367105148116102755780637e30e986116102445780637e30e9861461082b5780637f4f95fa14610840578063811b0b3914610899578063817da0fd146108ae576103b6565b806367105148146107275780636846992a1461073c5780636969a25c146107ec5780637a6e918214610816576103b6565b80635dd09590116102b15780635dd09590146106915780636233be5d146106c457806365d97724146106d9578063667dd61d14610712576103b6565b80633a73c881146105ec57806340550a1c1461060157806340a141ff146106345780634b3d500b14610667576103b6565b80631b5e358c1161035a578063308fe58211610329578063308fe5821461053357806337caa8b614610548578063399a87eb146105c25780633a061bd3146105d7576103b6565b80631b5e358c146104ae5780631d681516146104c35780632566392f146104d8578063264762041461050d576103b6565b80630aa01884116103965780630aa018841461045a5780630cc06e2b1461046f5780631303f7cf14610484578063158ef93e14610499576103b6565b8062362a77146103bb5780627ad09314610402578063079982a214610429575b600080fd5b3480156103c757600080fd5b506103ee600480360360208110156103de57600080fd5b50356001600160a01b0316611407565b604080519115158252519081900360200190f35b34801561040e57600080fd5b50610417611671565b60408051918252519081900360200190f35b34801561043557600080fd5b5061043e611677565b604080516001600160a01b039092168252519081900360200190f35b34801561046657600080fd5b5061043e61167d565b34801561047b57600080fd5b50610417611683565b34801561049057600080fd5b50610417611691565b3480156104a557600080fd5b506103ee611697565b3480156104ba57600080fd5b5061043e6116a0565b3480156104cf57600080fd5b506104176116af565b3480156104e457600080fd5b5061050b600480360360208110156104fb57600080fd5b50356001600160a01b03166116b5565b005b6103ee6004803603602081101561052357600080fd5b50356001600160a01b03166118c6565b34801561053f57600080fd5b5061043e611c96565b34801561055457600080fd5b506105726004803603602081101561056b57600080fd5b5035611c9c565b60408051602080825283518183015283519192839290830191858101910280838360005b838110156105ae578181015183820152602001610596565b505050509050019250505060405180910390f35b3480156105ce57600080fd5b5061043e611d87565b3480156105e357600080fd5b5061043e611d8d565b3480156105f857600080fd5b50610417611da1565b34801561060d57600080fd5b506103ee6004803603602081101561062457600080fd5b50356001600160a01b0316611da8565b34801561064057600080fd5b5061050b6004803603602081101561065757600080fd5b50356001600160a01b0316611e03565b34801561067357600080fd5b5061043e6004803603602081101561068a57600080fd5b5035611f4c565b34801561069d57600080fd5b5061050b600480360360208110156106b457600080fd5b50356001600160a01b0316611f73565b3480156106d057600080fd5b5061043e611fc9565b3480156106e557600080fd5b5061050b600480360360408110156106fc57600080fd5b506001600160a01b038135169060200135611fd8565b34801561071e57600080fd5b5061041761206e565b34801561073357600080fd5b5061043e612075565b34801561074857600080fd5b5061050b6004803603604081101561075f57600080fd5b810190602081018135600160201b81111561077957600080fd5b82018360208201111561078b57600080fd5b803590602001918460208302840111600160201b831117156107ac57600080fd5b919080806020026020016040519081016040528093929190818152602001838360200280828437600092019190915250929550509135925061207b915050565b3480156107f857600080fd5b5061043e6004803603602081101561080f57600080fd5b50356122c2565b34801561082257600080fd5b506104176122cf565b34801561083757600080fd5b5061043e61239d565b34801561084c57600080fd5b5061087b6004803603604081101561086357600080fd5b506001600160a01b03813581169160200135166123a3565b60408051938452602084019290925282820152519081900360600190f35b3480156108a557600080fd5b5061043e6123db565b3480156108ba57600080fd5b5061043e6123e1565b3480156108cf57600080fd5b506103ee600480360360208110156108e657600080fd5b50356001600160a01b03166123e7565b34801561090257600080fd5b506109296004803603602081101561091957600080fd5b50356001600160a01b031661264b565b60405180886001600160a01b0316815260200187600481111561094857fe5b815260200186815260200185815260200184815260200183815260200180602001828103825283818151815260200191508051906020019060200280838360005b838110156109a1578181015183820152602001610989565b505050509050019850505050505050505060405180910390f35b3480156109c757600080fd5b50610417612a91565b3480156109dc57600080fd5b50610417600480360360208110156109f357600080fd5b50356001600160a01b0316612a97565b348015610a0f57600080fd5b50610417612aa9565b348015610a2457600080fd5b50610417612ab9565b348015610a3957600080fd5b506103ee60048036036020811015610a5057600080fd5b50356001600160a01b0316612abf565b348015610a6c57600080fd5b50610572612b11565b348015610a8157600080fd5b50610417612b73565b348015610a9657600080fd5b5061050b60048036036020811015610aad57600080fd5b810190602081018135600160201b811115610ac757600080fd5b820183602082011115610ad957600080fd5b803590602001918460208302840111600160201b83111715610afa57600080fd5b509092509050612b83565b348015610b1157600080fd5b506103ee600480360360c0811015610b2857600080fd5b6001600160a01b038235169190810190604081016020820135600160201b811115610b5257600080fd5b820183602082011115610b6457600080fd5b803590602001918460018302840111600160201b83111715610b8557600080fd5b919390929091602081019035600160201b811115610ba257600080fd5b820183602082011115610bb457600080fd5b803590602001918460018302840111600160201b83111715610bd557600080fd5b919390929091602081019035600160201b811115610bf257600080fd5b820183602082011115610c0457600080fd5b803590602001918460018302840111600160201b83111715610c2557600080fd5b919390929091602081019035600160201b811115610c4257600080fd5b820183602082011115610c5457600080fd5b803590602001918460018302840111600160201b83111715610c7557600080fd5b919390929091602081019035600160201b811115610c9257600080fd5b820183602082011115610ca457600080fd5b803590602001918460018302840111600160201b83111715610cc557600080fd5b509092509050612efc565b348015610cdc57600080fd5b50610d0360048036036020811015610cf357600080fd5b50356001600160a01b0316613512565b60405180806020018060200180602001806020018060200186810386528b818151815260200191508051906020019080838360005b83811015610d50578181015183820152602001610d38565b50505050905090810190601f168015610d7d5780820380516001836020036101000a031916815260200191505b5086810385528a5181528a516020918201918c019080838360005b83811015610db0578181015183820152602001610d98565b50505050905090810190601f168015610ddd5780820380516001836020036101000a031916815260200191505b5086810384528951815289516020918201918b019080838360005b83811015610e10578181015183820152602001610df8565b50505050905090810190601f168015610e3d5780820380516001836020036101000a031916815260200191505b5086810383528851815288516020918201918a019080838360005b83811015610e70578181015183820152602001610e58565b50505050905090810190601f168015610e9d5780820380516001836020036101000a031916815260200191505b50868103825287518152875160209182019189019080838360005b83811015610ed0578181015183820152602001610eb8565b50505050905090810190601f168015610efd5780820380516001836020036101000a031916815260200191505b509a505050505050505050505060405180910390f35b348015610f1f57600080fd5b5061043e613946565b348015610f3457600080fd5b5061057261394c565b348015610f4957600080fd5b5061050b60048036036020811015610f6057600080fd5b50356139ac565b348015610f7357600080fd5b5061050b60048036036020811015610f8a57600080fd5b50356001600160a01b0316613a36565b348015610fa657600080fd5b5061043e613ac4565b348015610fbb57600080fd5b506103ee600480360360a0811015610fd257600080fd5b810190602081018135600160201b811115610fec57600080fd5b820183602082011115610ffe57600080fd5b803590602001918460018302840111600160201b8311171561101f57600080fd5b91908080601f0160208091040260200160405190810160405280939291908181526020018383808284376000920191909152509295949360208101935035915050600160201b81111561107157600080fd5b82018360208201111561108357600080fd5b803590602001918460018302840111600160201b831117156110a457600080fd5b91908080601f0160208091040260200160405190810160405280939291908181526020018383808284376000920191909152509295949360208101935035915050600160201b8111156110f657600080fd5b82018360208201111561110857600080fd5b803590602001918460018302840111600160201b8311171561112957600080fd5b91908080601f0160208091040260200160405190810160405280939291908181526020018383808284376000920191909152509295949360208101935035915050600160201b81111561117b57600080fd5b82018360208201111561118d57600080fd5b803590602001918460018302840111600160201b831117156111ae57600080fd5b91908080601f0160208091040260200160405190810160405280939291908181526020018383808284376000920191909152509295949360208101935035915050600160201b81111561120057600080fd5b82018360208201111561121257600080fd5b803590602001918460018302840111600160201b8311171561123357600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600092019190915250929550613adc945050505050565b34801561128057600080fd5b50610417613c81565b34801561129557600080fd5b5061043e613c90565b3480156112aa57600080fd5b50610417613c96565b3480156112bf57600080fd5b506112c8613ca6565b6040805192835260208301919091528051918290030190f35b3480156112ed57600080fd5b5061043e613cbb565b34801561130257600080fd5b5061130b613cca565b6040805161ffff9092168252519081900360200190f35b61050b613ccf565b34801561133657600080fd5b5061133f61405f565b6040805167ffffffffffffffff9092168252519081900360200190f35b34801561136857600080fd5b5061133f611671565b34801561137d57600080fd5b50610417614066565b34801561139257600080fd5b5061043e614074565b3480156113a757600080fd5b506103ee600480360360208110156113be57600080fd5b50356001600160a01b031661407a565b3480156113da57600080fd5b5061050b600480360360408110156113f157600080fd5b506001600160a01b038135169060200135614182565b600033816001600160a01b038416600090815260076020526040902054600160a01b900460ff16600481111561143957fe5b1415611482576040805162461bcd60e51b815260206004820152601360248201527215985b1a59185d1bdc881b9bdd08195e1a5cdd606a1b604482015290519081900360640190fd5b6001600160a01b038381166000908152600760205260409020548116908216146114dd5760405162461bcd60e51b815260040180806020018281038252602e815260200180615575602e913960400191505060405180910390fd5b6001600160a01b03831660009081526007602052604090206009015443617080909101111561153d5760405162461bcd60e51b815260040180806020018281038252605c81526020018061541e605c913960600191505060405180910390fd5b6001600160a01b03831660009081526007602081905260409091200154806115ac576040805162461bcd60e51b815260206004820152601a60248201527f596f7520646f6e2774206861766520616e792070726f66697473000000000000604482015290519081900360640190fd5b6001600160a01b0384166000908152600760208190526040822090810191909155436009909101558015611612576040516001600160a01b0383169082156108fc029083906000818181858888f19350505050158015611610573d6000803e3d6000fd5b505b816001600160a01b0316846001600160a01b03167f51a69b4502f660774c9339825c7b5adbf0b8622289134647e29728ec5d9b3bb98342604051808381526020018281526020019250505060405180910390a36001925050505b919050565b61708081565b61f00581565b61a00181565b690a968163f0a57b40000081565b600c5481565b60005460ff1681565b6001546001600160a01b031681565b6105b481565b3361f00914611702576040805162461bcd60e51b815260206004820152601460248201527350756e69736820636f6e7472616374206f6e6c7960601b604482015290519081900360640190fd5b60006001600160a01b038216600090815260076020526040902054600160a01b900460ff16600481111561173257fe5b14806117415750600954600110155b1561174b576118c3565b6001600160a01b03811673d1a4e4fbc69e17cabb96fd0d45cf98889b8503471415611775576118c3565b61177e81614218565b6001600160a01b038116600090815260076020526040902060010154690a968163f0a57b400000116117f7576001600160a01b0381166000908152600760205260409020600101546117da90690a968163f0a57b400000614332565b6001600160a01b0382166000908152600760205260409020600101555b6001600160a01b0381166000908152600760205260409020600101546a0422ca8b0a00a425000000111561184f576001600160a01b0381166000908152600760205260409020805460ff60a01b1916600360a01b1790555b6001600160a01b03811660009081526007602052604090206001015461187690829061437d565b60408051690a968163f0a57b400000815242602082015281516001600160a01b038416927f3cdf1ba6a0e21f7ff30da27188b092549ec0dff479879070791a6ef8e4e05054928290030190a25b50565b6000805460ff1661190d576040805162461bcd60e51b815260206004820152600c60248201526b139bdd081a5b9a5d081e595d60a21b604482015290519081900360640190fd5b816001806001600160a01b038516600090815260076020526040902054600160a01b900460ff16600481111561193f57fe5b1480611978575060026001600160a01b038516600090815260076020526040902054600160a01b900460ff16600481111561197657fe5b145b806119b0575060036001600160a01b038516600090815260076020526040902054600160a01b900460ff1660048111156119ae57fe5b145b6119eb5760405162461bcd60e51b815260040180806020018281038252602d8152602001806154c9602d913960400191505060405180910390fd5b600d546040805163416259d960e11b81526001600160a01b038781166004830152915191909216916382c4b3b2916024808301926020929190829003018186803b158015611a3857600080fd5b505afa158015611a4c573d6000803e3d6000fd5b505050506040513d6020811015611a6257600080fd5b5051611a9f5760405162461bcd60e51b81526004018080602001828103825260388152602001806155176038913960400191505060405180910390fd5b6001600160a01b0380831660009081526008602090815260408083209388168352929052206001015415611b045760405162461bcd60e51b81526004018080602001828103825260228152602001806154a76022913960400191505060405180910390fd5b6001600160a01b0380851660008181526007602090815260408083209487168352600882528083209383529290522054611b8957600a810180546001600160a01b038086166000818152600860209081526040808320948c16835293815292812060020184905560018401855593845292200180546001600160a01b03191690911790555b6001810154611b98908361438f565b600182015560028154600160a01b900460ff166004811115611bb657fe5b14611bcd57805460ff60a01b1916600160a11b1781555b611bdb85826001015461437d565b6001600160a01b03808416600090815260086020908152604080832093891683529290522054611c0b908361438f565b6001600160a01b038085166000908152600860209081526040808320938a1683529290522055600b54611c3e908361438f565b600b556040805183815242602082015281516001600160a01b0380891693908716927fb9ba725934532316cffe10975da6eb25ad49c2d1c294d982c46c9f8d684ee075929081900390910190a3506001949350505050565b61f00781565b6060600654821115611cae5760065491505b60608267ffffffffffffffff81118015611cc757600080fd5b50604051908082528060200260200182016040528015611cf1578160200160208202803683370190505b506001600090815260056020527f1471eb6eb2c5e789fc3de43f8ce62938c7d1836ec861730447e2ada8fd81017b549192506001600160a01b03909116905b84811015611d7e5781838281518110611d4557fe5b6001600160a01b039283166020918202929092018101919091529281166000908152600590935260409092205490911690600101611d30565b50909392505050565b61f00881565b60005461010090046001600160a01b031681565b6206978081565b6000805b600954811015611dfa57826001600160a01b031660098281548110611dcd57fe5b6000918252602090912001546001600160a01b03161415611df257600191505061166c565b600101611dac565b50600092915050565b3361f00914611e50576040805162461bcd60e51b815260206004820152601460248201527350756e69736820636f6e7472616374206f6e6c7960601b604482015290519081900360640190fd5b6001600160a01b03811660009081526007602081905260409091200154611e7682614218565b600a5460011015611f4857611e8a826143e9565b600d54604080516315ea278160e01b81526001600160a01b038581166004830152915191909216916315ea27819160248083019260209291908290030181600087803b158015611ed957600080fd5b505af1158015611eed573d6000803e3d6000fd5b505050506040513d6020811015611f0357600080fd5b50506040805182815242602082015281516001600160a01b038516927fa26de7ab324eac08c596549f421e5c8741213d237d2e9a2c9c0ebde0a7a849fe928290030190a25b5050565b600a8181548110611f5957fe5b6000918252602090912001546001600160a01b0316905081565b3361f00914611fc0576040805162461bcd60e51b815260206004820152601460248201527350756e69736820636f6e7472616374206f6e6c7960601b604482015290519081900360640190fd5b6118c381614218565b6002546001600160a01b031681565b6001600160a01b0382811660009081526005602052604090205416611ffc57611f48565b600061200783614456565b6001600160a01b03808516600090815260056020526040902054919250166120308284836144b3565b15612055576001600160a01b0384166000908152600460205260409020839055612068565b61205e84613a36565b6120688484614182565b50505050565b620d2f0081565b61f00b81565b3341146120bc576040805162461bcd60e51b815260206004820152600a6024820152694d696e6572206f6e6c7960b01b604482015290519081900360640190fd5b436000908152600f602090815260408083206001845290915290205460ff161561212d576040805162461bcd60e51b815260206004820152601a60248201527f56616c696461746f727320616c72656164792075706461746564000000000000604482015290519081900360640190fd5b60005460ff16612173576040805162461bcd60e51b815260206004820152600c60248201526b139bdd081a5b9a5d081e595d60a21b604482015290519081900360640190fd5b8080438161217d57fe5b06156121c3576040805162461bcd60e51b815260206004820152601060248201526f426c6f636b2065706f6368206f6e6c7960801b604482015290519081900360640190fd5b436000908152600f6020908152604080832060018085529252909120805460ff191690911790558251612234576040805162461bcd60e51b815260206004820152601460248201527356616c696461746f722073657420656d7074792160601b604482015290519081900360640190fd5b8251612247906009906020860190615250565b507feacea8f3c22f06c0b18306bdb04d0a967255129e8ce0094debb0a0ff89d006b5836040518080602001828103825283818151815260200191508051906020019060200280838360005b838110156122aa578181015183820152602001612292565b505050509050019250505060405180910390a1505050565b60098181548110611f5957fe5b600080805b60095481101561239757600260076000600984815481106122f157fe5b60009182526020808320909101546001600160a01b0316835282019290925260400190205460ff600160a01b90910416600481111561232c57fe5b14801561237c57506a0422ca8b0a00a425000000600760006009848154811061235157fe5b60009182526020808320909101546001600160a01b0316835282019290925260400190206001015410155b1561238f5761238c82600161438f565b91505b6001016122d4565b50905090565b61f00981565b6001600160a01b0391821660009081526008602090815260408083209390941682529190915220805460018201546002909201549092565b61a00281565b61f00381565b60003361f00a14612438576040805162461bcd60e51b815260206004820152601660248201527550726f706f73616c20636f6e7472616374206f6e6c7960501b604482015290519081900360640190fd5b60005460ff1661247e576040805162461bcd60e51b815260206004820152600c60248201526b139bdd081a5b9a5d081e595d60a21b604482015290519081900360640190fd5b60036001600160a01b038316600090815260076020526040902054600160a01b900460ff1660048111156124ae57fe5b141580156124ea575060046001600160a01b038316600090815260076020526040902054600160a01b900460ff1660048111156124e757fe5b14155b156124f75750600161166c565b60046001600160a01b038316600090815260076020526040902054600160a01b900460ff16600481111561252757fe5b14156125e857600e54604080516363e1d45160e01b81526001600160a01b038581166004830152915191909216916363e1d4519160248083019260209291908290030181600087803b15801561257c57600080fd5b505af1158015612590573d6000803e3d6000fd5b505050506040513d60208110156125a657600080fd5b50516125e8576040805162461bcd60e51b815260206004820152600c60248201526b18db19585b8819985a5b195960a21b604482015290519081900360640190fd5b6001600160a01b038216600081815260076020908152604091829020805460ff60a01b1916600160a01b179055815142815291517fd8b2c426ec1be69ca7583d26b1e893946e3227430d3ebc3bd64d9e1c469cb4009281900390910190a2919050565b600080600080600080606061265e6152b5565b6001600160a01b038981166000908152600760209081526040918290208251610100810190935280549384168352919290830190600160a01b900460ff1660048111156126a757fe5b60048111156126b257fe5b815260200160018201548152602001600282016040518060a0016040529081600082018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156127695780601f1061273e57610100808354040283529160200191612769565b820191906000526020600020905b81548152906001019060200180831161274c57829003601f168201915b50505050508152602001600182018054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561280b5780601f106127e05761010080835404028352916020019161280b565b820191906000526020600020905b8154815290600101906020018083116127ee57829003601f168201915b5050509183525050600282810180546040805160206001841615610100026000190190931694909404601f8101839004830285018301909152808452938101939083018282801561289d5780601f106128725761010080835404028352916020019161289d565b820191906000526020600020905b81548152906001019060200180831161288057829003601f168201915b505050918352505060038201805460408051602060026001851615610100026000190190941693909304601f81018490048402820184019092528181529382019392918301828280156129315780601f1061290657610100808354040283529160200191612931565b820191906000526020600020905b81548152906001019060200180831161291457829003601f168201915b505050918352505060048201805460408051602060026001851615610100026000190190941693909304601f81018490048402820184019092528181529382019392918301828280156129c55780601f1061299a576101008083540402835291602001916129c5565b820191906000526020600020905b8154815290600101906020018083116129a857829003601f168201915b5050505050815250508152602001600782015481526020016008820154815260200160098201548152602001600a8201805480602002602001604051908101604052809291908181526020018280548015612a4957602002820191906000526020600020905b81546001600160a01b03168152600190910190602001808311612a2b575b505050505081525050905080600001518160200151826040015183608001518460a001518560c001518660e00151975097509750975097509750975050919395979092949650565b600b5481565b60046020526000908152604090205481565b6b0d92289838d21a996800000081565b60065481565b6000805b600a54811015611dfa57826001600160a01b0316600a8281548110612ae457fe5b6000918252602090912001546001600160a01b03161415612b0957600191505061166c565b600101612ac3565b60606009805480602002602001604051908101604052809291908181526020018280548015612b6957602002820191906000526020600020905b81546001600160a01b03168152600190910190602001808311612b4b575b5050505050905090565b6b015b6a759f4835dc2400000081565b60005460ff1615612bd1576040805162461bcd60e51b8152602060048201526013602482015272105b1c9958591e481a5b9a5d1a585b1a5e9959606a1b604482015290519081900360640190fd5b600d80546001600160a01b031990811661f00a17909155600e8054821661f0091790556001600081815260056020527f1471eb6eb2c5e789fc3de43f8ce62938c7d1836ec861730447e2ada8fd81017b80549093169091179091555b81811015612eea576000838383818110612c4357fe5b905060200201356001600160a01b03166001600160a01b03161415612caf576040805162461bcd60e51b815260206004820152601960248201527f496e76616c69642076616c696461746f72206164647265737300000000000000604482015290519081900360640190fd5b612cd3838383818110612cbe57fe5b905060200201356001600160a01b0316611da8565b612d22576009838383818110612ce557fe5b835460018101855560009485526020948590200180546001600160a01b0319166001600160a01b0395909202939093013593909316929092179055505b612d46838383818110612d3157fe5b905060200201356001600160a01b0316612abf565b612d7857612d70838383818110612d5957fe5b905060200201356001600160a01b03166001614182565b612d78614523565b6000600781858585818110612d8957fe5b6001600160a01b0360209182029390930135831684528301939093526040909101600020541691909114159050612e3e57828282818110612dc657fe5b905060200201356001600160a01b031660076000858585818110612de657fe5b905060200201356001600160a01b03166001600160a01b03166001600160a01b0316815260200190815260200160002060000160006101000a8154816001600160a01b0302191690836001600160a01b031602179055505b600060076000858585818110612e5057fe5b602090810292909201356001600160a01b031683525081019190915260400160002054600160a01b900460ff166004811115612e8857fe5b1415612ee257600260076000858585818110612ea057fe5b602090810292909201356001600160a01b0316835250810191909152604001600020805460ff60a01b1916600160a01b836004811115612edc57fe5b02179055505b600101612c2d565b50506000805460ff1916600117905550565b6000805460ff16612f43576040805162461bcd60e51b815260206004820152600c60248201526b139bdd081a5b9a5d081e595d60a21b604482015290519081900360640190fd5b6001600160a01b038c16612f94576040805162461bcd60e51b8152602060048201526013602482015272496e76616c696420666565206164647265737360681b604482015290519081900360640190fd5b6130a38b8b8080601f01602080910402602001604051908101604052809392919081815260200183838082843760009201919091525050604080516020601f8f018190048102820181019092528d815292508d91508c908190840183828082843760009201919091525050604080516020601f8e018190048102820181019092528c815292508c91508b908190840183828082843760009201919091525050604080516020601f8d018190048102820181019092528b815292508b91508a908190840183828082843760009201919091525050604080516020601f8c018190048102820181019092528a815292508a9150899081908401838280828437600092019190915250613adc92505050565b6130ea576040805162461bcd60e51b815260206004820152601360248201527224b73b30b634b2103232b9b1b934b83a34b7b760691b604482015290519081900360640190fd5b336000818152600760205260408120548190600160a01b900460ff16600481111561311157fe5b141561321957600d546040805163416259d960e11b81526001600160a01b038581166004830152915191909216916382c4b3b2916024808301926020929190829003018186803b15801561316457600080fd5b505afa158015613178573d6000803e3d6000fd5b505050506040513d602081101561318e57600080fd5b50516131e1576040805162461bcd60e51b815260206004820152601c60248201527f596f75206d75737420626520617574686f72697a656420666972737400000000604482015290519081900360640190fd5b506001600160a01b0381166000908152600760205260408120805460ff60a01b1916600160a01b179055600190613219908390614182565b6001600160a01b038281166000908152600760205260409020548116908f161461328b578d60076000846001600160a01b03166001600160a01b0316815260200190815260200160002060000160006101000a8154816001600160a01b0302191690836001600160a01b031602179055505b6040518060a001604052808e8e8080601f016020809104026020016040519081016040528093929190818152602001838380828437600092019190915250505090825250604080516020601f8f018190048102820181019092528d815291810191908e908e9081908401838280828437600092019190915250505090825250604080516020601f8d018190048102820181019092528b815291810191908c908c9081908401838280828437600092019190915250505090825250604080516020601f8b0181900481028201810190925289815291810191908a908a9081908401838280828437600092019190915250505090825250604080516020601f89018190048102820181019092528781529181019190889088908190840183828082843760009201829052509390945250506001600160a01b038516815260076020908152604090912083518051600290920193506133eb928492910190615301565b5060208281015180516134049260018501920190615301565b5060408201518051613420916002840191602090910190615301565b506060820151805161343c916003840191602090910190615301565b5060808201518051613458916004840191602090910190615301565b5090505080156134b2578d6001600160a01b0316826001600160a01b03167f887eec9d757b7247dd8e51198f9d1b8f27979bceb34bdcc1bffd4ec5ec736c22426040518082815260200191505060405180910390a36134fe565b8d6001600160a01b0316826001600160a01b03167fb8421f65501371f54d58de1937ff1e1ccdb76423ef6f84acea1814a0f6362ca0426040518082815260200191505060405180910390a35b5060019d9c50505050505050505050505050565b60608060608060606135226152b5565b6001600160a01b038781166000908152600760209081526040918290208251610100810190935280549384168352919290830190600160a01b900460ff16600481111561356b57fe5b600481111561357657fe5b815260200160018201548152602001600282016040518060a0016040529081600082018054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561362d5780601f106136025761010080835404028352916020019161362d565b820191906000526020600020905b81548152906001019060200180831161361057829003601f168201915b50505050508152602001600182018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156136cf5780601f106136a4576101008083540402835291602001916136cf565b820191906000526020600020905b8154815290600101906020018083116136b257829003601f168201915b5050509183525050600282810180546040805160206001841615610100026000190190931694909404601f810183900483028501830190915280845293810193908301828280156137615780601f1061373657610100808354040283529160200191613761565b820191906000526020600020905b81548152906001019060200180831161374457829003601f168201915b505050918352505060038201805460408051602060026001851615610100026000190190941693909304601f81018490048402820184019092528181529382019392918301828280156137f55780601f106137ca576101008083540402835291602001916137f5565b820191906000526020600020905b8154815290600101906020018083116137d857829003601f168201915b505050918352505060048201805460408051602060026001851615610100026000190190941693909304601f81018490048402820184019092528181529382019392918301828280156138895780601f1061385e57610100808354040283529160200191613889565b820191906000526020600020905b81548152906001019060200180831161386c57829003601f168201915b5050505050815250508152602001600782015481526020016008820154815260200160098201548152602001600a820180548060200260200160405190810160405280929190818152602001828054801561390d57602002820191906000526020600020905b81546001600160a01b031681526001909101906020018083116138ef575b5050509190925250505060609081015180516020820151604083015193830151608090930151919b909a50929850909650945092505050565b61f00681565b6060600a805480602002602001604051908101604052809291908181526020018280548015612b69576020028201919060005260206000209081546001600160a01b03168152600190910190602001808311612b4b575050505050905090565b3341146139ed576040805162461bcd60e51b815260206004820152600a6024820152694d696e6572206f6e6c7960b01b604482015290519081900360640190fd5b6a0422ca8b0a00a42500000081116118c35760405162461bcd60e51b815260040180806020018281038252602d81526020018061547a602d913960400191505060405180910390fd5b6001600160a01b0381811660009081526005602052604090205416613a5a576118c3565b6000613a6582614456565b6001600160a01b039283166000818152600560209081526040808320805495881684528184208054969098166001600160a01b031996871617909755928252855490931690945560049091528220919091555060068054600019019055565b73d1a4e4fbc69e17cabb96fd0d45cf98889b85034781565b6000604686511115613b2e576040805162461bcd60e51b8152602060048201526016602482015275092dcecc2d8d2c840dadedcd2d6cae440d8cadccee8d60531b604482015290519081900360640190fd5b610bb885511115613b86576040805162461bcd60e51b815260206004820152601760248201527f496e76616c6964206964656e74697479206c656e677468000000000000000000604482015290519081900360640190fd5b608c84511115613bd6576040805162461bcd60e51b8152602060048201526016602482015275092dcecc2d8d2c840eecac4e6d2e8ca40d8cadccee8d60531b604482015290519081900360640190fd5b608c83511115613c24576040805162461bcd60e51b8152602060048201526014602482015273092dcecc2d8d2c840cadac2d2d840d8cadccee8d60631b604482015290519081900360640190fd5b61011882511115613c75576040805162461bcd60e51b8152602060048201526016602482015275092dcecc2d8d2c840c8cae8c2d2d8e640d8cadccee8d60531b604482015290519081900360640190fd5b50600195945050505050565b6a0422ca8b0a00a42500000081565b61f00a81565b6b07fdacf155df27a328c0000081565b600080613cb360006146a7565b915091509091565b6003546001600160a01b031681565b603381565b334114613d10576040805162461bcd60e51b815260206004820152600a6024820152694d696e6572206f6e6c7960b01b604482015290519081900360640190fd5b436000908152600f6020908152604080832083805290915290205460ff1615613d80576040805162461bcd60e51b815260206004820152601960248201527f426c6f636b20697320616c726561647920726577617264656400000000000000604482015290519081900360640190fd5b60005460ff16613dc6576040805162461bcd60e51b815260206004820152600c60248201526b139bdd081a5b9a5d081e595d60a21b604482015290519081900360640190fd5b436000908152600f602090815260408083208380528252808320805460ff191660011790553380845260079092528220549091680ad78ebc5ac620000091600160a01b900460ff166004811115613e1957fe5b1415613e2657505061405d565b600061a0026001600160a01b03166318160ddd6040518163ffffffff1660e01b815260040160206040518083038186803b158015613e6357600080fd5b505afa158015613e77573d6000803e3d6000fd5b505050506040513d6020811015613e8d57600080fd5b505160408051635fdf60fb60e01b8152905191925060009161a00291635fdf60fb916004808301926020929190829003018186803b158015613ece57600080fd5b505afa158015613ee2573d6000803e3d6000fd5b505050506040513d6020811015613ef857600080fd5b505160408051630ac168a160e01b8152905191925060009161a00291630ac168a1916004808301926020929190829003018186803b158015613f3957600080fd5b505afa158015613f4d573d6000803e3d6000fd5b505050506040513d6020811015613f6357600080fd5b505190506000613f7f6064613f7984600a614796565b906147ef565b905080613f8c8585614332565b118015613fa357506000613fa08683614332565b10155b156140095761f00b6001600160a01b03166330f3f0db826040518263ffffffff1660e01b815260040180828152602001915050600060405180830381600087803b158015613ff057600080fd5b505af1158015614004573d6000803e3d6000fd5b505050505b614014856000614831565b6040805186815242602082015281516001600160a01b038916927f7dc4e5df59513708dca355b8706273a5df7b810a4cec8019f2a4b9bb166a1a04928290030190a25050505050505b565b6201518081565b693ceab05409db274d269381565b61f00481565b600061408533611da8565b6140d6576040805162461bcd60e51b815260206004820152601d60248201527f6f6e6c7920616374697665642076616c696461746f722063616e20646f000000604482015290519081900360640190fd5b6009546140e283614b5a565b1561411e5760405162461bcd60e51b815260040180806020018281038252602681526020018061554f6026913960400191505060405180910390fd5b60005b8181101561417857336001600160a01b03166009828154811061414057fe5b6000918252602090912001546001600160a01b03161415614170576141653385614baf565b60019250505061166c565b600101614121565b5060009392505050565b6001600160a01b0382811660009081526005602052604090205416156141a757611f48565b60006141b2826150d0565b6001600160a01b0380851660008181526004602090815260408083208890559484168083526005909152848220805484845295832080546001600160a01b0319908116979096169690961790955590528254909116179055506006805460010190555050565b60006001600160a01b038216600090815260076020526040902054600160a01b900460ff16600481111561424857fe5b14806142575750600954600110155b15614261576118c3565b6001600160a01b0381166000908152600760208190526040909120015480156142ec5761428e8183614831565b600c5461429b908261438f565b600c556001600160a01b0382166000908152600760205260409020600801546142c4908261438f565b6001600160a01b03831660009081526007602081905260408220600881019390935591909101555b6040805182815242602082015281516001600160a01b038516927fe294e9d73f8eee23e21b2e1567960625a6b5d339cb127b55d0d09473a9951235928290030190a25050565b600061437483836040518060400160405280601e81526020017f536166654d6174683a207375627472616374696f6e206f766572666c6f770000815250615129565b90505b92915050565b6143878282611fd8565b611f48614523565b600082820183811015614374576040805162461bcd60e51b815260206004820152601b60248201527f536166654d6174683a206164646974696f6e206f766572666c6f770000000000604482015290519081900360640190fd5b60006001600160a01b038216600090815260076020526040902054600160a01b900460ff16600481111561441957fe5b1415614424576118c3565b6001600160a01b0381166000908152600760205260409020805460ff60a01b1916600160a21b1790556118c3816151c0565b600060015b6001600160a01b0381811660009081526005602052604090205416600114611dfa5761448783826151c9565b1561449357905061166c565b6001600160a01b039081166000908152600560205260409020541661445b565b60006001600160a01b038416600114806144e557506001600160a01b0384166000908152600460205260409020548311155b801561451b57506001600160a01b0382166001148061451b57506001600160a01b03821660009081526004602052604090205483115b949350505050565b6060614530600654611c9c565b905061453e600a600061537b565b80516000805b828110156120685773d1a4e4fbc69e17cabb96fd0d45cf98889b8503476001600160a01b031684828151811061457657fe5b60200260200101516001600160a01b031614156145f257600a84828151811061459b57fe5b60209081029190910181015182546001808201855560009485529290932090920180546001600160a01b0319166001600160a01b0390931692909217909155919091019060338214156145ed57612068565b61469f565b6a0422ca8b0a00a4250000006007600086848151811061460e57fe5b60200260200101516001600160a01b03166001600160a01b03168152602001908152602001600020600101541061469f57600a84828151811061464d57fe5b60209081029190910181015182546001808201855560009485529290932090920180546001600160a01b0319166001600160a01b03909316929092179091559190910190603382141561469f57612068565b600101614544565b60008060005b60095481101561479057600460076000600984815481106146ca57fe5b60009182526020808320909101546001600160a01b0316835282019290925260400190205460ff600160a01b90910416600481111561470557fe5b1415801561473757506009818154811061471b57fe5b6000918252602090912001546001600160a01b03858116911614155b156147885761477f600760006009848154811061475057fe5b60009182526020808320909101546001600160a01b03168352820192909252604001902060010154849061438f565b92506001909101905b6001016146ad565b50915091565b6000826147a557506000614377565b828202828482816147b257fe5b04146143745760405162461bcd60e51b81526004018080602001828103825260218152602001806154f66021913960400191505060405180910390fd5b600061437483836040518060400160405280601a81526020017f536166654d6174683a206469766973696f6e206279207a65726f0000000000008152506151eb565b8161483b57611f48565b600080614847836146a7565b909250905080614858575050611f48565b600080836149ca57600061486c87856147ef565b905061488261487b8286614796565b8890614332565b925060005b60095481101561495d576000600982815481106148a057fe5b6000918252602090912001546001600160a01b0316905060046001600160a01b038216600090815260076020526040902054600160a01b900460ff1660048111156148e757fe5b141580156149075750876001600160a01b0316816001600160a01b031614155b15614954576001600160a01b03811660009081526007602081905260409091200154614933908461438f565b6001600160a01b038216600090815260076020819052604090912001559250825b50600101614887565b5060008311801561497657506001600160a01b03821615155b156149c0576001600160a01b038216600090815260076020819052604090912001546149a2908461438f565b6001600160a01b038316600090815260076020819052604090912001555b5050505050611f48565b6000805b600954811015614ae2576000600982815481106149e757fe5b6000918252602090912001546001600160a01b0316905060046001600160a01b038216600090815260076020526040902054600160a01b900460ff166004811115614a2e57fe5b14158015614a4e5750876001600160a01b0316816001600160a01b031614155b15614ad9576001600160a01b038116600090815260076020526040812060010154614a80908990613f79908d90614796565b9050614a8c848261438f565b6001600160a01b0383166000908152600760208190526040909120015492955093508491614aba908261438f565b6001600160a01b03831660009081526007602081905260409091200155505b506001016149ce565b50614aed8782614332565b9250600083118015614b0757506001600160a01b03821615155b15614b51576001600160a01b03821660009081526007602081905260409091200154614b33908461438f565b6001600160a01b038316600090815260076020819052604090912001555b50505050505050565b600954600090815b8181101561417857836001600160a01b031660098281548110614b8157fe5b6000918252602090912001546001600160a01b03161415614ba75760019250505061166c565b600101614b62565b6001600160a01b03828116600090815260076020819052604080832060018082015495871685529190932090810193909355818101549083015560088082015490830155548154600160a01b9182900460ff16929160ff60a01b1990911690836004811115614c1a57fe5b02179055506001600160a01b03818116600081815260076020908152604080832080546001600160a01b0319169094179093559285168152818120805460ff60a01b1916600160a21b178155600181018290556008810191909155600a018054825181850281018501909352808352606093830182828015614cc557602002820191906000526020600020905b81546001600160a01b03168152600190910190602001808311614ca7575b505083519394506000925050505b81811015614efc5760076000856001600160a01b03166001600160a01b03168152602001908152602001600020600a01838281518110614d0f57fe5b60209081029190910181015182546001810184556000938452919092200180546001600160a01b0319166001600160a01b03909216919091179055614d52615399565b60086000858481518110614d6257fe5b60200260200101516001600160a01b03166001600160a01b031681526020019081526020016000206000876001600160a01b03166001600160a01b0316815260200190815260200160002060405180606001604052908160008201548152602001600182015481526020016002820154815250509050806000015160086000868581518110614ded57fe5b60200260200101516001600160a01b03166001600160a01b031681526020019081526020016000206000876001600160a01b03166001600160a01b0316815260200190815260200160002060000181905550806020015160086000868581518110614e5457fe5b60200260200101516001600160a01b03166001600160a01b031681526020019081526020016000206000876001600160a01b03166001600160a01b0316815260200190815260200160002060010181905550806040015160086000868581518110614ebb57fe5b6020908102919091018101516001600160a01b0390811683528282019390935260409182016000908120938a16815292905290206002015550600101614cd3565b506001600160a01b0384166000908152600760205260408120614f2491600a9091019061537b565b6001600160a01b038316600090815260076020526040902060010154614f4b908490614182565b614f5484613a36565b6001600160a01b03841660009081526007602081905260408220018054919055614f7c614523565b614f8585614218565b600d5460408051631204145960e01b81526001600160a01b038881166004830152878116602483015291519190921691631204145991604480830192600092919082900301818387803b158015614fdb57600080fd5b505af1158015614fef573d6000803e3d6000fd5b505050506001600a8054905011156150c95761500a856143e9565b600d54604080516315ea278160e01b81526001600160a01b038881166004830152915191909216916315ea27819160248083019260209291908290030181600087803b15801561505957600080fd5b505af115801561506d573d6000803e3d6000fd5b505050506040513d602081101561508357600080fd5b50506040805142815290516001600160a01b0380871692908816917fc99c7a81ac29d57ca44522273d13fd4f068d63d610b2631d7f1271a484bcc5179181900360200190a35b5050505050565b600060015b6001600160a01b038082166000908152600560205260409020546150fd9183918691166144b3565b1561510957905061166c565b6001600160a01b03908116600090815260056020526040902054166150d5565b600081848411156151b85760405162461bcd60e51b81526004018080602001828103825283818151815260200191508051906020019080838360005b8381101561517d578181015183820152602001615165565b50505050905090810190601f1680156151aa5780820380516001836020036101000a031916815260200191505b509250505060405180910390fd5b505050900390565b6118c381613a36565b6001600160a01b03908116600090815260056020526040902054811691161490565b6000818361523a5760405162461bcd60e51b815260206004820181815283516024840152835190928392604490910191908501908083836000831561517d578181015183820152602001615165565b50600083858161524657fe5b0495945050505050565b8280548282559060005260206000209081019282156152a5579160200282015b828111156152a557825182546001600160a01b0319166001600160a01b03909116178255602090920191600190910190615270565b506152b19291506153ba565b5090565b604080516101008101909152600080825260208201908152602001600081526020016152df6153d9565b8152602001600081526020016000815260200160008152602001606081525090565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061534257805160ff191683800117855561536f565b8280016001018555821561536f579182015b8281111561536f578251825591602001919060010190615354565b506152b1929150615408565b50805460008255906000526020600020908101906118c39190615408565b60405180606001604052806000815260200160008152602001600081525090565b5b808211156152b15780546001600160a01b03191681556001016153bb565b6040518060a0016040528060608152602001606081526020016060815260200160608152602001606081525090565b5b808211156152b1576000815560010161540956fe596f75206d757374207761697420656e6f75676820626c6f636b7320746f20776974686472617720796f75722070726f66697473206166746572206c6174657374207769746864726177206f6620746869732076616c696461746f726e65772076616c7565206d757374206c6172676572207468616e204d696e696d616c5374616b696e67436f696e43616e2774207374616b65207768656e20796f752061726520756e7374616b696e6743616e2774207374616b6520746f20612076616c696461746f7220696e2061626e6f726d616c20737461747573536166654d6174683a206d756c7469706c69636174696f6e206f766572666c6f775468652076616c696461746f7220796f752077616e7420746f207374616b65206d75737420626520617574686f72697a6564206669727374616464726573732069732076616c696461746f722c2063616e206e6f74207265757365206974596f7520617265206e6f742074686520666565207265636569766572206f6620746869732076616c696461746f72a2646970667358221220b03d10033a5b22217ff369861cfda9133544c40e0317cf894f28860939f732b464736f6c634300060c0033"
)

type forkValidatorsV3 struct {
}

func (f *forkValidatorsV3) GetName() string {
	return ValidatorsV3ContractName
}

func (f *forkValidatorsV3) Update(config *params.ChainConfig, height *big.Int, state *state.StateDB) (err error) {
	contractCode := common.FromHex(validatorV3Code)

	//write code to sys contract
	state.SetCode(ValidatorsV3ContractAddr, contractCode)
	log.Debug("Write code to system contract account", "addr", ValidatorsV3ContractAddr.String(), "code", validatorV3Code)

	return
}

func (f *forkValidatorsV3) Execute(state *state.StateDB, header *types.Header, chainContext core.ChainContext, config *params.ChainConfig) (err error) {

	//First, get top validators from the old contract
	v2 := NewValidatorV2()
	topVals, err := v2.GetTopValidators(state, header, chainContext, config)
	if err != nil {
		log.Error("getTopValidators from V0 failed", "err", err)
		return err
	}
	// managers := make([]common.Address, 0, len(topVals))
	// for _, val := range topVals {
	// 	feeAddr, err := v0.GetValidatorFeeAddr(val, state, header, chainContext, config)
	// 	if err != nil {
	// 		return err
	// 	}
	// 	managers = append(managers, feeAddr)
	// }

	// initialize v1 contract
	// fmt.Println(topVals)
	method := "initialize"
	data, err := GetInteractiveABI()[ValidatorsV3ContractName].Pack(method, topVals)
	if err != nil {
		log.Error("Can't pack data for initialize", "error", err)
		return err
	}

	msg := types.NewMessage(header.Coinbase, &ValidatorsV3ContractAddr, 0, new(big.Int), math.MaxUint64, new(big.Int), data, false)
	_, err = caller.ExecuteMsg(msg, state, header, chainContext, config)

	return
}
